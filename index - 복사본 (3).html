<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆëˆ (ì±„ë„ ì•Œë¦¼)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜, ì•Œë¦¼ íŒì—… ìŠ¤íƒ€ì¼ë§Œ ìœ ì§€ */
        body { font-family: 'Pretendard', sans-serif; background-color: #121212; color: #eee; margin: 0; padding: 0; padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }
        .navbar { position: sticky; top: 0; z-index: 100; background-color: #1e1e1e; border-bottom: 1px solid #333; padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 50px; box-sizing: border-box; }
        .nav-title { font-size: 1.2rem; font-weight: bold; }
        .back-btn { background: none; border: none; color: #aaa; font-size: 1rem; display: none; cursor: pointer; }
        .user-badge { background: #333; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; border: 1px solid #444; }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 60px; background: #1e1e1e; border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-sizing: border-box; }
        .tab-item { flex: 1; text-align: center; color: #777; cursor: pointer; padding: 10px 0; }
        .tab-item.active { color: #2980b9; font-weight: bold; }
        .tab-icon { font-size: 1.2rem; margin-bottom: 3px; display: block; }
        .tab-text { font-size: 0.8rem; }
        
        .view-section { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        
        .big-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 100px; margin-bottom: 15px; background: #2c2c2c; border-radius: 12px; border: 1px solid #3a3a3a; padding: 0 25px; box-sizing: border-box; cursor: pointer; }
        .line-label { font-size: 1.8rem; font-weight: 800; }
        .badge { display: inline-block; padding: 5px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; margin-left: 5px; color: #fff; }
        .badge-err { background-color: #e74c3c; animation: pulse 1.5s infinite; }
        .badge-fix { background-color: #3498db; }
        .badge-ok { color: #2ecc71; }
        
        .line-group { margin-bottom: 25px; }
        .line-head { font-size: 1.1rem; font-weight: bold; color: #aaa; margin-bottom: 10px; padding-left: 5px; border-left: 4px solid #555; }
        .ops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .op-card { background: #333; border: 1px solid #444; border-radius: 8px; padding: 10px; cursor: pointer; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .op-num { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .op-info { font-size: 0.7rem; opacity: 0.9; line-height: 1.2; }
        .st-RUN { background: #27ae60; border-color: #2ecc71; color: white; }
        .st-DOWN { background: #c0392b; border-color: #e74c3c; color: white; animation: blink 1s infinite alternate; }
        .st-PM { background: #2980b9; border-color: #3498db; color: white; }
        
        .history-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 15px; }
        .hist-time { font-size: 0.8rem; color: #aaa; min-width: 50px; text-align: right; margin-top: 3px; }
        .hist-content { flex: 1; }
        .hist-line { font-weight: bold; font-size: 1rem; color: #fff; margin-bottom: 5px; }
        .hist-chip { display: inline-block; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
        .chip-CALL { background: #e74c3c; color: white; }
        .chip-START { background: #f39c12; color: black; }
        .chip-FINISH { background: #27ae60; color: white; }
        .hist-desc { font-size: 0.85rem; color: #ccc; margin-top: 5px; line-height: 1.4; }
        .hist-user { font-size: 0.8rem; color: #777; margin-top: 5px; text-align: right; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #222; width: 90%; max-width: 400px; border-radius: 10px; padding: 20px; max-height: 80vh; overflow-y: auto; text-align: center; }
        .code-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .code-btn { background: #333; border: 1px solid #555; padding: 15px 5px; border-radius: 5px; cursor: pointer; text-align: center; }
        .code-btn.selected { background: #2ecc71; color: #000; font-weight: bold; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .login-input { width: 100%; padding: 15px; margin: 8px 0; border-radius: 8px; border: none; background: #333; color: white; font-size: 1rem; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; margin-top: 15px; border-radius: 8px; border: none; background: #2980b9; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        #alert-popup { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background-color: #c0392b; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 9999; animation: slideDown 0.5s; align-items: center; justify-content: space-between; }
        #alert-popup strong { font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .alert-close { background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
    </style>
</head>
<body>

    <div id="alert-popup">
        <div><strong>ğŸš¨ ë¼ì¸ í˜¸ì¶œ ë°œìƒ!</strong><span id="alert-msg">-</span></div>
        <button class="alert-close" onclick="closeAlert()">ë‹«ê¸°</button>
    </div>

    <audio id="siren-sound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..." preload="auto"></audio>

    <div id="login-modal" class="modal-overlay" style="display:flex;">
        <div class="modal-content">
            <h2 style="color:white; margin-bottom:30px;">ğŸ­ ANDON LOGIN</h2>
            <input type="text" id="uid" class="login-input" placeholder="ID">
            <input type="password" id="upw" class="login-input" placeholder="PW">
            <button onclick="login()" class="login-btn">LOGIN</button>
            <p id="msg" style="color:#e74c3c; margin-top:15px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="code-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">ì½”ë“œ ì„ íƒ</h3>
            <div id="modal-step-1">
                <div id="step-1-title" style="margin-bottom:10px; color:#aaa;">STEP 1</div>
                <div class="code-list" id="code-list-1"></div>
            </div>
            <div id="modal-step-2" style="display:none; margin-top:20px; border-top:1px dashed #444; padding-top:10px;">
                <div id="step-2-title" style="margin-bottom:10px; color:#aaa;">STEP 2</div>
                <div class="code-list" id="code-list-2"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" style="background:#555; color:white;" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn" style="background:#2980b9; color:white; opacity:0.5; pointer-events:none;" id="modal-confirm-btn" onclick="confirmCodeSelection()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <button id="back-btn" class="back-btn" onclick="goHomeMain()">â® ëª©ë¡</button>
        <div class="nav-title" id="page-title">í†µí•© ëª¨ë‹ˆí„°ë§</div>
        <div class="user-badge" id="user-display" onclick="logout()">-</div>
    </div>

    <div id="tab-monitor" class="view-section active">
        <div id="home-view">
            <div class="big-btn" onclick="goDetail('BSA')">
                <span class="line-label">BSA</span><div id="badge-BSA">...</div>
            </div>
            <div class="big-btn" onclick="goDetail('BPA')">
                <span class="line-label">BPA</span><div id="badge-BPA">...</div>
            </div>
            <div class="big-btn" onclick="goDetail('BMA')">
                <span class="line-label">BMA</span><div id="badge-BMA">...</div>
            </div>
        </div>
        <div id="detail-view" style="display:none;"></div>
    </div>

    <div id="tab-history" class="view-section">
        <div style="text-align:center; padding:10px; color:#888; font-size:0.9rem;">ìµœê·¼ 50ê±´ ì´ë ¥</div>
        <div id="history-list"></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('monitor')" id="btn-tab-monitor">
            <span class="tab-icon">ğŸ“Š</span><span class="tab-text">ëª¨ë‹ˆí„°ë§</span>
        </div>
        <div class="tab-item" onclick="switchTab('history')" id="btn-tab-history">
            <span class="tab-icon">ğŸ•’</span><span class="tab-text">ì´ë ¥ì¡°íšŒ</span>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸš¨ í…”ë ˆê·¸ë¨ ì±„ë„ ì„¤ì • (ì—¬ê¸°ì— IDë¥¼ ì…ë ¥í•˜ì„¸ìš”)
        // ============================================
        const TELEGRAM_BOT_TOKEN = '8252490040:AAG8mc_2WB00BaFGHAwp0NEJEhWj-Qw81VY'; 
        
        // 2ë‹¨ê³„ì—ì„œ ì•Œì•„ë‚¸ "-100..." ìˆ«ìë¥¼ ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— ë„£ìœ¼ì„¸ìš”.
        // ì˜ˆ: const TELEGRAM_CHANNEL_ID = '-1001234567890';
        const TELEGRAM_CHANNEL_ID = '-1003437379356'; 

        // ============================================
        
        const supabaseUrl = 'https://xtcoovvghttnwxwdttqa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Y29vdnZnaHR0bnd4d2R0dHFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDE3NzYsImV4cCI6MjA3Njg3Nzc3Nn0.Fmn9b1FoyklF5jw0oiLKp4JT1zRTY9iq9hiCog6HHpE';
        
        const memoryStorage = { store: {}, getItem: function(k){return this.store[k]||null}, setItem: function(k,v){this.store[k]=v}, removeItem: function(k){delete this.store[k]} };
        const client = supabase.createClient(supabaseUrl, supabaseKey, { auth: { storage: memoryStorage, persistSession: false, autoRefreshToken: false, detectSessionInUrl: false } });
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

        let currentUser = null;
        let allData = [];
        let codeData = [];
        let currentItem = null;
        let sel1 = null, sel2 = null;

        // --- ì´ˆê¸°í™” ---
        async function init() {
            const { data } = await client.from('MA_CODE_DATA').select('*');
            if(data) codeData = data;
            
            try { 
                const saved = localStorage.getItem('andon_v7_user'); 
                if(saved) { 
                    currentUser = JSON.parse(saved); 
                    applyLogin(); 
                } 
            } catch(e){}
        }

        // --- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ---
        async function login() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            const { data, error } = await client.from('MA_USER').select('*').eq('id', id).eq('pw', pw).single();
            if (error || !data) { document.getElementById('msg').innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨"; return; }
            currentUser = data;
            localStorage.setItem('andon_v7_user', JSON.stringify(data));
            applyLogin();
        }

        function applyLogin() {
            document.getElementById('login-modal').style.display = 'none';
            const role = currentUser.cmf_1 === 'ADMIN' ? 'ğŸ‘‘' : (currentUser.cmf_1 === 'MAINT' ? 'ğŸ”§' : 'ğŸ‘·');
            document.getElementById('user-display').innerText = `${role} ${currentUser.id}`;
            fetchData();
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('andon_v7_user');
                location.reload();
            }
        }

        // --- í…”ë ˆê·¸ë¨ ë°œì†¡ í•¨ìˆ˜ ---
        function sendNotification(msg) {
            // ì±„ë„ IDê°€ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´ ê±°ê¸°ë¡œ ë³´ë‚´ê³ , ì•„ë‹ˆë©´ ê²½ê³ 
            if (!TELEGRAM_CHANNEL_ID) {
                console.warn("í…”ë ˆê·¸ë¨ ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHANNEL_ID}&text=${encodeURIComponent(msg)}`;
            fetch(url).then(res => res.json()).then(data => {
                if(!data.ok) console.error("í…”ë ˆê·¸ë¨ ë°œì†¡ ì‹¤íŒ¨:", data.description);
            }).catch(e => console.error(e));
        }

        // --- ëª¨ë‹ˆí„°ë§ UI ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if(tabName === 'history') fetchHistory();
        }

        async function fetchData() {
            const { data } = await client.from('andon_lines').select('*').order('line_code').order('operation_code');
            if(data) { allData = data; updateUI(); }
        }

        function updateUI() {
            ['BSA', 'BPA', 'BMA'].forEach(type => {
                const lines = allData.filter(d => d.line_type === type);
                const down = lines.filter(d => d.status === 'DOWN').length;
                const pm = lines.filter(d => d.status === 'PM').length;
                let html = '';
                if(down>0) html += `<span class="badge badge-err">ğŸš¨ ${down}</span>`;
                if(pm>0) html += `<span class="badge badge-fix">ğŸ”§ ${pm}</span>`;
                if(down==0 && pm==0) html = `<span class="badge badge-ok">ì •ìƒ</span>`;
                document.getElementById(`badge-${type}`).innerHTML = html;
            });
            if(document.getElementById('detail-view').style.display === 'block') {
                const type = document.getElementById('page-title').innerText.split(' ')[0];
                renderDetail(type);
            }
        }

        function goDetail(type) {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('page-title').innerText = `${type} ë¼ì¸ ìƒì„¸`;
            renderDetail(type);
        }

        function goHomeMain() {
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('page-title').innerText = 'í†µí•© ëª¨ë‹ˆí„°ë§';
        }

        function renderDetail(type) {
            const container = document.getElementById('detail-view');
            container.innerHTML = '';
            const targetData = allData.filter(d => d.line_type === type);
            const grouped = {};
            targetData.forEach(d => { if(!grouped[d.line_code]) grouped[d.line_code] = []; grouped[d.line_code].push(d); });

            Object.keys(grouped).sort().forEach(code => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'line-group';
                groupDiv.innerHTML = `<div class="line-head">${code}</div>`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'ops-grid';

                grouped[code].forEach(item => {
                    const card = document.createElement('div');
                    card.className = `op-card st-${item.status}`;
                    let subInfo = '';
                    if(item.status === 'DOWN' && item.last_message) subInfo = `<div class="op-info">${item.last_user_id}<br>${item.last_message}</div>`;
                    else if(item.status === 'PM') subInfo = `<div class="op-info">ì¡°ì¹˜ì¤‘<br>${item.last_user_id}</div>`;
                    card.innerHTML = `<div class="op-num">${item.operation_code}</div> ${subInfo}`;
                    card.onclick = () => handleClick(item);
                    gridDiv.appendChild(card);
                });
                groupDiv.appendChild(gridDiv);
                container.appendChild(groupDiv);
            });
        }

        // --- ìƒíƒœ ë³€ê²½ ë° ëª¨ë‹¬ ---
        async function handleClick(item) {
            currentItem = item; sel1 = null; sel2 = null;
            const role = currentUser.cmf_1;
            if (item.status === 'RUN') {
                if(role!=='PROD' && role!=='ADMIN') return alert('ìƒì‚°ì§ ê¶Œí•œ í•„ìš”');
                openModal('FAIL_PHEN', 'ê³ ì¥ í˜„ìƒ', false);
            } else if (item.status === 'DOWN') {
                if(role!=='MAINT' && role!=='ADMIN') return alert('ë³´ì „ë°˜ ê¶Œí•œ í•„ìš”');
                if(confirm('ë³´ì „ ì‹œì‘?')) await updateStatus('PM', 'START', null, null, null, null);
            } else if (item.status === 'PM') {
                if(role!=='MAINT' && role!=='ADMIN') return alert('ë³´ì „ë°˜ ê¶Œí•œ í•„ìš”');
                openModal('FAIL_CAUSE', 'ê³ ì¥ ì›ì¸', true, 'ACTION_CODE', 'ì¡°ì¹˜ ë‚´ìš©');
            }
        }

        function openModal(t1, title1, isDouble, t2, title2) {
            if(!renderCodeList(t1, 'code-list-1', 1)) return alert('ì½”ë“œ ë°ì´í„° ì—†ìŒ');
            document.getElementById('code-modal').style.display = 'flex';
            document.getElementById('modal-step-2').style.display = isDouble ? 'block' : 'none';
            document.getElementById('step-1-title').innerText = title1;
            if(isDouble) {
                renderCodeList(t2, 'code-list-2', 2);
                document.getElementById('step-2-title').innerText = title2;
            }
            updateConfirm();
        }

        function renderCodeList(table, elId, step) {
            const list = document.getElementById(elId);
            list.innerHTML = '';
            const filtered = codeData.filter(c => (c.TABLE_NAME || c.table_name) === table);
            if(filtered.length === 0) return false;
            filtered.forEach(c => {
                const key = c.KEY_1 || c.key_1;
                const desc = c.DATA_2 || c.data_2;
                const btn = document.createElement('div');
                btn.className = 'code-btn';
                btn.innerHTML = `<div style="font-size:1.1rem;margin-bottom:2px;">${key}</div><div style="font-size:0.75rem;color:#aaa;">${desc}</div>`;
                btn.onclick = () => {
                    const obj = { KEY_1: key, DATA_2: desc };
                    if(step===1) sel1 = obj; else sel2 = obj;
                    Array.from(list.children).forEach(ch=>ch.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateConfirm();
                };
                list.appendChild(btn);
            });
            return true;
        }

        function updateConfirm() {
            const isDouble = document.getElementById('modal-step-2').style.display === 'block';
            const btn = document.getElementById('modal-confirm-btn');
            if((!isDouble && sel1) || (isDouble && sel1 && sel2)) btn.style.opacity = '1', btn.style.pointerEvents = 'auto';
            else btn.style.opacity = '0.5', btn.style.pointerEvents = 'none';
        }
        function closeModal() { document.getElementById('code-modal').style.display = 'none'; }

        async function confirmCodeSelection() {
            const isDouble = document.getElementById('modal-step-2').style.display === 'block';
            if(!isDouble) {
                await updateStatus('DOWN', 'CALL', sel1.KEY_1, null, null, sel1.DATA_2);
                // [í…”ë ˆê·¸ë¨ ë°œì†¡] ì±„ë„ë¡œ ë©”ì‹œì§€ ì „ì†¡
                const msg = `ğŸš¨ [ë¼ì¸í˜¸ì¶œ ë°œìƒ]\nğŸ“ ìœ„ì¹˜: ${currentItem.line_code} - OP${currentItem.operation_code}\nğŸ”§ í˜„ìƒ: ${sel1.DATA_2} (${sel1.KEY_1})\nğŸ‘¤ í˜¸ì¶œì: ${currentUser.id}`;
                sendNotification(msg);
            } else {
                await updateStatus('RUN', 'FINISH', null, sel1.KEY_1, sel2.KEY_1, `ì›ì¸:${sel1.KEY_1}/ì¡°ì¹˜:${sel2.KEY_1}`);
            }
            closeModal();
        }

        async function updateStatus(st, type, phen, cause, act, msg) {
            await client.from('andon_lines').update({ status: st, last_user_id: currentUser.id, last_message: msg, last_updated_at: new Date() }).eq('id', currentItem.id);
            await client.from('andon_history').insert({ line_id: currentItem.id, user_id: currentUser.id, action_type: type, status_snapshot: st, fail_phen_code: phen, fail_cause_code: cause, action_code: act, message: msg });
        }

        // --- ì•Œë¦¼ íŠ¸ë¦¬ê±° ---
        function triggerAlert(lineCode, opCode) {
            if(currentUser && (currentUser.cmf_1 === 'MAINT' || currentUser.cmf_1 === 'ADMIN')) {
                audio.play().catch(e => {});
                document.getElementById('alert-msg').innerText = `${lineCode} - OP ${opCode}`;
                document.getElementById('alert-popup').style.display = 'flex';
                if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
            }
        }
        function closeAlert() { document.getElementById('alert-popup').style.display = 'none'; }

        client.channel('v7-realtime')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'andon_lines' }, payload => {
                fetchData();
                if(payload.eventType === 'UPDATE' && payload.new.status === 'DOWN' && payload.old.status !== 'DOWN') {
                    triggerAlert(payload.new.line_code, payload.new.operation_code);
                }
            }).subscribe();
            
        async function fetchHistory() {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '<div style="text-align:center;padding:20px;">ë¡œë”©ì¤‘...</div>';
            const { data } = await client.from('andon_history').select('*').order('created_at', { ascending: false }).limit(50);
            if(!data || data.length === 0) { listDiv.innerHTML = '<div style="text-align:center;padding:20px;">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            listDiv.innerHTML = '';
            data.forEach(h => {
                const lineInfo = allData.find(l => l.id === h.line_id);
                const lineName = lineInfo ? `${lineInfo.line_code} - OP${lineInfo.operation_code}` : 'Unknown';
                let detail = h.message || '-';
                if(h.fail_phen_code) detail = `í˜„ìƒ: ${getCodeDesc('FAIL_PHEN', h.fail_phen_code)}`;
                if(h.fail_cause_code) detail = `ì›ì¸: ${getCodeDesc('FAIL_CAUSE', h.fail_cause_code)} <br> ì¡°ì¹˜: ${getCodeDesc('ACTION_CODE', h.action_code)}`;
                const d = new Date(h.created_at);
                const t = `${d.getMonth()+1}/${d.getDate()} <br> ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                let chip = h.action_type;
                if(chip==='CALL') chip='í˜¸ì¶œ'; if(chip==='START') chip='ì‹œì‘'; if(chip==='FINISH') chip='ì™„ë£Œ';
                listDiv.innerHTML += `<div class="history-card"><div class="hist-time">${t}</div><div class="hist-content"><div class="hist-line"><span class="hist-chip chip-${h.action_type}">${chip}</span>${lineName}</div><div class="hist-desc">${detail}</div><div class="hist-user">by ${h.user_id}</div></div></div>`;
            });
        }

        function getCodeDesc(table, key) {
            const found = codeData.find(c => (c.TABLE_NAME||c.table_name)===table && (c.KEY_1||c.key_1)===key);
            return found ? `${found.DATA_2||found.data_2} (${key})` : key;
        }

        init();
    </script>
</body>
</html>