<script>
        // Supabase ì„¤ì •
        const memoryStorage = { store: {}, getItem: function(k){return this.store[k]||null}, setItem: function(k,v){this.store[k]=v}, removeItem: function(k){delete this.store[k]} };
        const supabaseUrl = 'https://xtcoovvghttnwxwdttqa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Y29vdnZnaHR0bnd4d2R0dHFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDE3NzYsImV4cCI6MjA3Njg3Nzc3Nn0.Fmn9b1FoyklF5jw0oiLKp4JT1zRTY9iq9hiCog6HHpE';
        const client = supabase.createClient(supabaseUrl, supabaseKey, { auth: { storage: memoryStorage, persistSession: false, autoRefreshToken: false, detectSessionInUrl: false } });

        let currentUser = null;
        let allData = [];
        let codeData = [];
        let currentItem = null;
        let sel1 = null, sel2 = null;

        // --- ì´ˆê¸°í™” ---
        async function init() {
            // [ìˆ˜ì •ë¨] ë°ì´í„° ë¡œë”© í™•ì¸ ë¡œê·¸
            const { data, error } = await client.from('MA_CODE_DATA').select('*');
            if(error) {
                console.error("ì½”ë“œ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                alert("ì½”ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. DB ê¶Œí•œ(RLS)ì„ í™•ì¸í•˜ì„¸ìš”.");
            } else if(data) {
                console.log("ë¡œë“œëœ ì½”ë“œ ë°ì´í„°:", data); // F12 ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥
                codeData = data;
            }
            
            // ë¡œê·¸ì¸ ì²´í¬
            try { 
                const saved = localStorage.getItem('andon_v4_user'); 
                if(saved) { 
                    currentUser = JSON.parse(saved); 
                    applyLogin(); 
                } else { 
                    document.getElementById('login-modal').style.display = 'flex'; 
                } 
            } catch(e){ 
                document.getElementById('login-modal').style.display = 'flex'; 
            }
        }

        async function login() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            // ëŒ€ë¬¸ì í…Œì´ë¸” ëª…ì‹œ
            const { data, error } = await client.from('MA_USER').select('*').eq('id', id).eq('pw', pw).single();
            if (error || !data) { document.getElementById('msg').innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨"; return; }
            currentUser = data;
            localStorage.setItem('andon_v4_user', JSON.stringify(data));
            applyLogin();
        }

        function applyLogin() {
            document.getElementById('login-modal').style.display = 'none';
            const role = currentUser.cmf_1 === 'ADMIN' ? 'ğŸ‘‘' : (currentUser.cmf_1 === 'MAINT' ? 'ğŸ”§' : 'ğŸ‘·');
            document.getElementById('user-display').innerText = `${role} ${currentUser.id}`;
            fetchData();
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('andon_v4_user');
                location.reload();
            }
        }

        // --- íƒ­ ì „í™˜ ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if(tabName === 'history') fetchHistory();
        }

        // --- ëª¨ë‹ˆí„°ë§ ë¡œì§ ---
        async function fetchData() {
            const { data } = await client.from('andon_lines').select('*').order('line_code').order('operation_code');
            if(data) { allData = data; updateUI(); }
        }

        function updateUI() {
            ['BSA', 'BPA', 'BMA'].forEach(type => {
                const lines = allData.filter(d => d.line_type === type);
                const down = lines.filter(d => d.status === 'DOWN').length;
                const pm = lines.filter(d => d.status === 'PM').length;
                let html = '';
                if(down>0) html += `<span class="badge badge-err">ğŸš¨ ${down}</span>`;
                if(pm>0) html += `<span class="badge badge-fix">ğŸ”§ ${pm}</span>`;
                if(down==0 && pm==0) html = `<span class="badge badge-ok">ì •ìƒ</span>`;
                document.getElementById(`badge-${type}`).innerHTML = html;
            });
            if(document.getElementById('detail-view').style.display === 'block') {
                const type = document.getElementById('page-title').innerText.split(' ')[0];
                if(['BSA','BPA','BMA'].includes(type)) renderDetail(type);
            }
        }

        function goDetail(type) {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('page-title').innerText = `${type} ë¼ì¸ ìƒì„¸`;
            renderDetail(type);
        }

        function goHomeMain() {
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('page-title').innerText = 'í†µí•© ëª¨ë‹ˆí„°ë§';
        }

        function renderDetail(type) {
            const container = document.getElementById('detail-view');
            container.innerHTML = '';
            const targetData = allData.filter(d => d.line_type === type);
            const grouped = {};
            targetData.forEach(d => { if(!grouped[d.line_code]) grouped[d.line_code] = []; grouped[d.line_code].push(d); });

            Object.keys(grouped).sort().forEach(code => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'line-group';
                groupDiv.innerHTML = `<div class="line-head">${code}</div>`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'ops-grid';

                grouped[code].forEach(item => {
                    const card = document.createElement('div');
                    card.className = `op-card st-${item.status}`;
                    let subInfo = '';
                    if(item.status === 'DOWN' && item.last_message) subInfo = `<div class="op-info">${item.last_user_id}<br>${item.last_message}</div>`;
                    else if(item.status === 'PM') subInfo = `<div class="op-info">ì¡°ì¹˜ì¤‘<br>${item.last_user_id}</div>`;
                    card.innerHTML = `<div class="op-num">${item.operation_code}</div> ${subInfo}`;
                    card.onclick = () => handleClick(item);
                    gridDiv.appendChild(card);
                });
                groupDiv.appendChild(gridDiv);
                container.appendChild(groupDiv);
            });
        }

        // --- ìƒíƒœ ë³€ê²½ ë° ëª¨ë‹¬ ---
        async function handleClick(item) {
            currentItem = item; sel1 = null; sel2 = null;
            const role = currentUser.cmf_1;

            if (item.status === 'RUN') {
                // RUN -> DOWN (ê³ ì¥ í˜¸ì¶œ) : ìƒì‚°ì§(op1) ë˜ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
                if(role!=='PROD' && role!=='ADMIN') return alert(`ì‘ì—…ì í˜¸ì¶œì€ ìƒì‚°ì§(PROD)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬ ê¶Œí•œ: ${role}`);
                
                // ë°ì´í„° ë¡œë“œ í™•ì¸
                if(codeData.length === 0) return alert("ì½”ë“œ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                
                openModal('FAIL_PHEN', 'ê³ ì¥ í˜„ìƒ', false);
            } 
            else if (item.status === 'DOWN') {
                // DOWN -> PM (ë³´ì „ ì‹œì‘) : ë³´ì „ë°˜(eng1) ë˜ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
                if(role!=='MAINT' && role!=='ADMIN') return alert(`ì¡°ì¹˜ ì‹œì‘ì€ ë³´ì „ë°˜(MAINT)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬ ê¶Œí•œ: ${role}`);
                if(confirm('ë³´ì „ ì‘ì—…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await updateStatus('PM', 'START', null, null, null, null);
            } 
            else if (item.status === 'PM') {
                // PM -> RUN (ë³´ì „ ì™„ë£Œ) : ë³´ì „ë°˜(eng1) ë˜ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
                if(role!=='MAINT' && role!=='ADMIN') return alert(`ì¡°ì¹˜ ì™„ë£ŒëŠ” ë³´ì „ë°˜(MAINT)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬ ê¶Œí•œ: ${role}`);
                openModal('FAIL_CAUSE', 'ê³ ì¥ ì›ì¸', true, 'ACTION_CODE', 'ì¡°ì¹˜ ë‚´ìš©');
            }
        }

        function openModal(t1, title1, isDouble, t2, title2) {
            const list1 = document.getElementById('code-list-1');
            const list2 = document.getElementById('code-list-2');
            
            // ë¦¬ìŠ¤íŠ¸ 1 ë Œë”ë§
            const hasData1 = renderCodeList(t1, 'code-list-1', 1);
            if(!hasData1) {
                alert(`DBì—ì„œ '${t1}' ê´€ë ¨ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nMA_CODE_DATA í…Œì´ë¸” ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                return;
            }

            document.getElementById('code-modal').style.display = 'flex';
            document.getElementById('modal-step-2').style.display = isDouble ? 'block' : 'none';
            document.getElementById('step-1-title').innerText = title1;
            
            if(isDouble) {
                renderCodeList(t2, 'code-list-2', 2);
                document.getElementById('step-2-title').innerText = title2;
            }
            updateConfirm();
        }

        function renderCodeList(table, elId, step) {
            const list = document.getElementById(elId);
            list.innerHTML = '';
            
            // [í•µì‹¬ ìˆ˜ì •] ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  í•„í„°ë§ (DBì»¬ëŸ¼ì´ TABLE_NAME ì´ë“  table_name ì´ë“  ì‘ë™)
            const filtered = codeData.filter(c => {
                const dbTable = c.TABLE_NAME || c.table_name; // ëŒ€ì†Œë¬¸ì í˜¸í™˜
                return dbTable === table;
            });

            if(filtered.length === 0) return false; // ë°ì´í„° ì—†ìŒ

            filtered.forEach(c => {
                const key = c.KEY_1 || c.key_1;
                const desc = c.DATA_2 || c.data_2;

                const btn = document.createElement('div');
                btn.className = 'code-btn';
                btn.innerHTML = `<div style="font-size:1.1rem;margin-bottom:2px;">${key}</div><div style="font-size:0.75rem;color:#aaa;">${desc}</div>`;
                btn.onclick = () => {
                    // ê°ì²´ ì¬êµ¬ì„± (ëŒ€ì†Œë¬¸ì í†µì¼)
                    const selectedObj = { KEY_1: key, DATA_2: desc };
                    
                    if(step===1) sel1 = selectedObj; else sel2 = selectedObj;
                    Array.from(list.children).forEach(ch=>ch.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateConfirm();
                };
                list.appendChild(btn);
            });
            return true;
        }

        function updateConfirm() {
            const isDouble = document.getElementById('modal-step-2').style.display === 'block';
            const btn = document.getElementById('modal-confirm-btn');
            if((!isDouble && sel1) || (isDouble && sel1 && sel2)) {
                btn.style.opacity = '1'; btn.style.pointerEvents = 'auto';
            } else {
                btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none';
            }
        }
        function closeModal() { document.getElementById('code-modal').style.display = 'none'; }

        async function confirmCodeSelection() {
            const isDouble = document.getElementById('modal-step-2').style.display === 'block';
            if(!isDouble) await updateStatus('DOWN', 'CALL', sel1.KEY_1, null, null, sel1.DATA_2);
            else await updateStatus('RUN', 'FINISH', null, sel1.KEY_1, sel2.KEY_1, `ì›ì¸:${sel1.KEY_1}/ì¡°ì¹˜:${sel2.KEY_1}`);
            closeModal();
        }

        async function updateStatus(st, type, phen, cause, act, msg) {
            await client.from('andon_lines').update({ status: st, last_user_id: currentUser.id, last_message: msg, last_updated_at: new Date() }).eq('id', currentItem.id);
            await client.from('andon_history').insert({ line_id: currentItem.id, user_id: currentUser.id, action_type: type, status_snapshot: st, fail_phen_code: phen, fail_cause_code: cause, action_code: act, message: msg });
        }

        // --- ì´ë ¥ ì¡°íšŒ ---
        async function fetchHistory() {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '<div style="text-align:center;padding:20px;">ë¡œë”©ì¤‘...</div>';
            const { data } = await client.from('andon_history').select('*').order('created_at', { ascending: false }).limit(50);
            if(!data || data.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center;padding:20px;">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            listDiv.innerHTML = '';
            data.forEach(h => {
                const lineInfo = allData.find(l => l.id === h.line_id);
                const lineName = lineInfo ? `${lineInfo.line_code} - OP${lineInfo.operation_code}` : 'Unknown Line';
                
                let detailText = h.message || '-';
                // ì´ë ¥ ì¡°íšŒ ì‹œì—ë„ ëŒ€ì†Œë¬¸ì í˜¸í™˜ìš© í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©
                if(h.fail_phen_code) detailText = `í˜„ìƒ: ${getCodeDesc('FAIL_PHEN', h.fail_phen_code)}`;
                if(h.fail_cause_code) detailText = `ì›ì¸: ${getCodeDesc('FAIL_CAUSE', h.fail_cause_code)} <br> ì¡°ì¹˜: ${getCodeDesc('ACTION_CODE', h.action_code)}`;

                const date = new Date(h.created_at);
                const timeStr = `${date.getMonth()+1}/${date.getDate()} <br> ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                let chipLabel = h.action_type;
                if(h.action_type==='CALL') chipLabel = 'í˜¸ì¶œ';
                if(h.action_type==='START') chipLabel = 'ì‹œì‘';
                if(h.action_type==='FINISH') chipLabel = 'ì™„ë£Œ';

                const html = `
                    <div class="history-card">
                        <div class="hist-time">${timeStr}</div>
                        <div class="hist-content">
                            <div class="hist-line">
                                <span class="hist-chip chip-${h.action_type}">${chipLabel}</span>
                                ${lineName}
                            </div>
                            <div class="hist-desc">${detailText}</div>
                            <div class="hist-user">by ${h.user_id}</div>
                        </div>
                    </div>
                `;
                listDiv.innerHTML += html;
            });
        }

        // [í•µì‹¬ ìˆ˜ì •] ì½”ë“œ ì„¤ëª… ì°¾ê¸° (ëŒ€ì†Œë¬¸ì í˜¸í™˜)
        function getCodeDesc(table, key) {
            const found = codeData.find(c => {
                const tName = c.TABLE_NAME || c.table_name;
                const kName = c.KEY_1 || c.key_1;
                return tName === table && kName === key;
            });
            if(found) return `${found.DATA_2 || found.data_2} (${key})`;
            return key;
        }

        client.channel('v4-realtime').on('postgres_changes', { event: '*', schema: 'public', table: 'andon_lines' }, fetchData).subscribe();
        init();
    </script>
</body>
</html>